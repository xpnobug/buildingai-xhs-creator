# 🎨 buildingai-xhs-creator 技术架构

> 小红书图文生成插件的完整技术解析

---

## 一、系统架构

### 整体分层

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面                              │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ 主生成页 │  │ 历史记录 │  │ 后台配置 │  │ 任务详情 │        │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘        │
└───────┼────────────┼────────────┼────────────┼──────────────┘
        │            │            │            │
        ▼            ▼            ▼            ▼
┌─────────────────────────────────────────────────────────────┐
│                     Pinia 状态管理                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  xhs-creator.ts: 主题/大纲/页面/生成进度/任务历史     │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │ HTTP / SSE
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      NestJS 后端                            │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐               │
│  │ 大纲控制器 │  │ 图片控制器 │  │ 任务控制器 │               │
│  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘               │
│        │              │              │                      │
│        ▼              ▼              ▼                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              业务服务层                               │  │
│  │  OutlineService │ ImageService │ XhsBillingService   │  │
│  └──────────────────────────────────────────────────────┘  │
│                          │                                  │
│                          ▼                                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              AI 生成器                                │  │
│  │  ImagesGenerator │ ChatGenerator │ CustomGenerator   │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                       数据层                                │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ XhsTask │  │ XhsImage│  │XhsConfig│  │XhsUsage │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、核心流程

### 1. 大纲生成

```
用户输入主题
    │
    ▼
┌─────────────────┐
│  构建提示词      │  ← 加载 outline_prompt.txt 模板
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  调用 AI 模型    │  ← 使用系统配置的文本模型
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  解析大纲结构    │  ← 拆分为 [封面, 内容×N, 总结]
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  创建任务记录    │  → 返回 taskId + pages
└─────────────────┘
```

### 2. 图片生成 (SSE 实时推送)

```
点击"生成图片"
    │
    ▼
┌─────────────────────────┐
│  验证余额                │  ← 检查免费次数 / 积分余额
└───────────┬─────────────┘
            │ 余额充足
            ▼
┌─────────────────────────┐
│  阶段一：生成封面         │
│  ├─ SSE: "正在生成封面"   │
│  ├─ 扣减积分              │
│  ├─ 调用 AI 生成图片      │
│  ├─ 保存版本记录          │
│  └─ SSE: "封面完成"       │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  阶段二：生成内容页       │  ← 封面作为风格参考
│  ├─ 循环每页              │
│  │   ├─ SSE: "第N页..."  │
│  │   ├─ 扣减积分          │
│  │   ├─ 生成图片          │
│  │   └─ SSE: "第N页完成"  │
│  └─ (可选: 高并发模式)    │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│  SSE: "全部完成"         │
└─────────────────────────┘
```

### 3. 计费机制

```
请求生成
    │
    ▼
┌─────────────────┐    有    ┌─────────────────┐
│  检查免费次数    │ ───────▶ │  消费免费次数    │
└────────┬────────┘          │  (不扣积分)      │
         │ 无                └─────────────────┘
         ▼
┌─────────────────┐    足    ┌─────────────────┐
│  检查积分余额    │ ───────▶ │  预扣积分        │
└────────┬────────┘          └────────┬────────┘
         │ 不足                       │
         ▼                            ▼
┌─────────────────┐          ┌─────────────────┐
│  返回错误        │          │  执行生成        │
└─────────────────┘          └────────┬────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │ 成功                              │ 失败
                    ▼                                   ▼
          ┌─────────────────┐                ┌─────────────────┐
          │  确认扣费        │                │  回退积分        │
          └─────────────────┘                └─────────────────┘
```

**积分配置：**

| 操作 | 默认积分 |
|------|----------|
| 大纲生成 | 10 |
| 封面图 | 80 |
| 内容图 | 40 |
| 免费次数 | 5 次/用户 |

### 4. 版本管理

```
首次生成 ──▶ 版本 1 (isCurrent=true)
                │
重绘请求 ──▶ 版本 2 (isCurrent=true) ──┐
                │                      │
再次重绘 ──▶ 版本 3 (isCurrent=true)   │
                                      │
恢复到版本 1 ◀──────────────────────────┘
(不创建新版本，仅切换 isCurrent)
```

---

## 三、技术栈

### 前端

| 技术 | 用途 |
|------|------|
| **Nuxt 3** | SSR 框架 |
| **Vue 3** | UI 组件 |
| **Pinia** | 状态管理 |
| **vue-waterfall-plugin-next** | 瀑布流布局 |

### 后端

| 技术 | 用途 |
|------|------|
| **NestJS** | 主框架 |
| **TypeORM** | 数据库 ORM |
| **RxJS** | SSE 流式响应 |
| **BuildingAI SDK** | AI 模型调用 |

---

## 四、目录结构

```
src/
├── api/                          # 后端
│   ├── db/entities/              # 数据实体
│   │   ├── xhs-task.entity.ts
│   │   ├── xhs-image.entity.ts
│   │   ├── xhs-image-history.entity.ts
│   │   ├── xhs-config.entity.ts
│   │   └── xhs-user-usage.entity.ts
│   │
│   └── modules/xhs-creator/
│       ├── controllers/          # 接口控制器
│       ├── services/             # 业务服务
│       ├── generators/           # AI 生成器
│       ├── dto/                  # 数据传输对象
│       └── prompts/              # 提示词模板
│
└── web/                          # 前端
    ├── pages/                    # 页面
    │   ├── index.vue             # 主生成页
    │   ├── history.vue           # 历史记录
    │   └── console/config.vue    # 后台配置
    ├── components/xhs/           # 业务组件
    ├── stores/xhs-creator.ts     # 状态管理
    └── services/xhs/api.ts       # API 封装
```

---

## 五、数据模型

### XhsTask (任务)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| topic | string | 用户主题 |
| outline | text | 大纲文本 |
| pages | JSONB | 页面结构 |
| status | enum | 任务状态 |
| coverImageUrl | string | 封面图 URL |
| userId | UUID | 创建用户 |

**状态流转：**
```
PENDING → GENERATING_OUTLINE → OUTLINE_READY → GENERATING_IMAGES → COMPLETED
                                                        ↓
                                                     FAILED
```

### XhsImage (图片)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| taskId | UUID | 所属任务 |
| pageIndex | int | 页面索引 |
| pageType | enum | cover/content/summary |
| imageUrl | string | 图片 URL |
| currentVersion | int | 当前版本号 |
| powerAmount | int | 消耗积分 |

### XhsImageHistory (版本历史)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| imageId | UUID | 关联图片 |
| version | int | 版本号 |
| imageUrl | string | 该版本图片 |
| prompt | text | 使用的提示词 |
| generatedBy | enum | initial/single-regenerate/batch-regenerate |
| isCurrent | boolean | 是否当前版本 |

---

## 六、API 接口

### 大纲

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/outline` | 生成大纲 |

### 图片

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/images/generate` | 批量生成 (SSE) |
| POST | `/images/regenerate` | 单张重绘 |
| GET | `/images/:taskId/:pageIndex/versions` | 版本历史 |
| POST | `/images/:taskId/:pageIndex/restore/:version` | 恢复版本 |

### 任务

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/tasks` | 任务列表 |
| GET | `/tasks/:id` | 任务详情 |

### 配置

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/config` | 获取配置 |
| PUT | `/config` | 更新配置 |

### 余额

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/balance/check` | 检查余额 |

---

## 七、关键特性

| 特性 | 实现方式 |
|------|----------|
| **SSE 实时进度** | RxJS Subject 推送生成状态 |
| **风格一致性** | 封面图作为内容页参考图 |
| **预扣积分** | 生成前扣减，失败自动回退 |
| **增量重绘** | 只重绘修改过的页面 |
| **版本管理** | 每次重绘保存历史，支持恢复 |
| **高并发模式** | 可选并行生成内容页 |
| **断线重连** | 支持从服务器恢复生成进度 |

---

## 八、版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0.0 | - | 初始版本 |
