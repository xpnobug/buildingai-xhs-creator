# 本地开发扩展部署到线上环境指南

本文档详细说明如何将本地开发的扩展部署到线上环境（不通过市场）。

---

## 目录

1. [部署方式概述](#1-部署方式概述)
2. [方式一：打包 ZIP 手动部署（推荐）](#2-方式一打包-zip-手动部署推荐)
3. [方式二：通过数据库直接注册](#3-方式二通过数据库直接注册)
4. [方式三：Git 同步 + 自动部署](#4-方式三git-同步--自动部署)
5. [目录结构要求](#5-目录结构要求)
6. [自动化脚本](#6-自动化脚本)
7. [常见问题](#7-常见问题)

---

## 1. 部署方式概述

| 方式 | 适用场景 | 复杂度 | 推荐度 |
|------|----------|--------|--------|
| **ZIP 打包部署** | 正式发布、版本管理 | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| **数据库直接注册** | 快速测试、热修复 | ⭐⭐⭐ | ⭐⭐⭐ |
| **Git 同步部署** | 持续集成、团队协作 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

---

## 2. 方式一：打包 ZIP 手动部署（推荐）

### 2.1 本地构建发布包

```bash
# 进入扩展目录
cd extensions/buildingai-xhs-creator

# 执行发布构建
pnpm build:publish
```

构建过程：
1. `pnpm clean` - 清理旧的构建产物
2. `pnpm build:web` - 构建前端（生成 `.output/public/`）
3. `pnpm build:api` - 构建后端（生成 `build/`）
4. 复制前端资源到 `public/web/extensions/{name}/`

### 2.2 创建 ZIP 包

```bash
# 回到扩展根目录
cd extensions/buildingai-xhs-creator

# 打包必要的文件
zip -r buildingai-xhs-creator-v1.1.0.zip \
    build/ \
    .output/public/ \
    manifest.json \
    package.json
```

**必须包含的目录**：

| 目录/文件 | 说明 | 必须 |
|-----------|------|------|
| `build/` | 后端编译产物 | ✅ |
| `.output/public/` | 前端编译产物 | ✅ |
| `manifest.json` | 扩展清单 | ✅ |
| `package.json` | 包配置 | ✅ |

### 2.3 线上服务器安装

#### 步骤 1：上传 ZIP 包
```bash
scp buildingai-xhs-creator-v1.1.0.zip user@server:/tmp/
```

#### 步骤 2：解压到 extensions 目录
```bash
ssh user@server
cd /path/to/buildingai

# 解压（如果是升级，先备份）
unzip /tmp/buildingai-xhs-creator-v1.1.0.zip -d extensions/buildingai-xhs-creator
```

#### 步骤 3：复制前端资源
```bash
mkdir -p public/web/extensions/buildingai-xhs-creator
cp -r extensions/buildingai-xhs-creator/.output/public/* \
      public/web/extensions/buildingai-xhs-creator/
```

#### 步骤 4：安装依赖并重启
```bash
pnpm install
pm2 restart all
```

---

## 3. 方式二：通过数据库直接注册

如果扩展文件已经在服务器上（如通过 Git 部署），可以直接注册。

### 3.1 更新 extensions.json

编辑项目根目录的 `extensions.json`：

```json
{
    "applications": {
        "buildingai-xhs-creator": {
            "manifest": {
                "identifier": "buildingai-xhs-creator",
                "name": "小红书图文生成",
                "version": "1.1.0",
                "description": "BuildingAI 小红书图文生成插件"
            },
            "isLocal": true,
            "enabled": true,
            "installedAt": "2025-12-07T00:00:00.000Z"
        }
    }
}
```

### 3.2 插入数据库记录

```sql
-- PostgreSQL 示例
INSERT INTO extensions (
    id, 
    name, 
    identifier, 
    version, 
    description, 
    icon, 
    type, 
    status, 
    is_local, 
    created_at, 
    updated_at
) VALUES (
    gen_random_uuid(),
    '小红书图文生成',
    'buildingai-xhs-creator',
    '1.1.0',
    'BuildingAI 小红书图文生成插件',
    '/extensions/buildingai-xhs-creator/icon.png',
    'application',
    'enabled',
    true,
    NOW(),
    NOW()
);
```

### 3.3 重启服务
```bash
pm2 restart all
```

---

## 4. 方式三：Git 同步 + 自动部署

### 4.1 提交本地更改
```bash
git add extensions/buildingai-xhs-creator/
git commit -m "feat: update xhs-creator to v1.1.0"
git push origin main
```

### 4.2 线上服务器拉取
```bash
ssh user@server
cd /path/to/buildingai
git pull origin main
```

### 4.3 构建并重启
```bash
# 安装依赖
pnpm install

# 构建扩展
cd extensions/buildingai-xhs-creator
pnpm build:publish

# 重启服务
pm2 restart all
```

### 4.4 CI/CD 自动化

可以配置 GitHub Actions 或其他 CI 工具自动化此流程：

```yaml
# .github/workflows/deploy-extension.yml
name: Deploy Extension

on:
  push:
    paths:
      - 'extensions/buildingai-xhs-creator/**'
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install pnpm
        run: npm install -g pnpm
        
      - name: Install dependencies
        run: pnpm install
        
      - name: Build extension
        run: |
          cd extensions/buildingai-xhs-creator
          pnpm build:publish
          
      - name: Deploy to server
        run: |
          # 使用 SSH 部署到服务器
          # 或者使用 rsync 同步文件
```

---

## 5. 目录结构要求

无论使用哪种部署方式，扩展必须包含以下结构：

```
BuildingAI/
├── extensions/                    # 扩展安装目录
│   └── {identifier}/             # 具体扩展目录
│       ├── build/                # ✅ 必须 - 后端编译产物
│       │   ├── index.js
│       │   └── index.d.ts
│       ├── .output/
│       │   └── public/           # ✅ 必须 - 前端编译产物
│       │       ├── _nuxt/
│       │       └── index.html
│       ├── manifest.json         # ✅ 必须 - 扩展清单
│       ├── package.json          # ✅ 必须 - 包配置
│       ├── data/                 # 可选 - 数据目录（升级时保留）
│       ├── storage/              # 可选 - 存储目录（升级时保留）
│       └── node_modules/         # 可选 - 依赖（升级时保留）
│
├── public/web/extensions/        # 前端资源公共目录
│   └── {identifier}/             # 扩展前端资源（从 .output/public 复制）
│       ├── _nuxt/
│       └── index.html
│
├── storage/temp/                 # 下载缓存目录
│   └── {identifier}-{version}.zip
│
└── extensions.json               # 扩展配置文件
```

---

## 6. 自动化脚本

本扩展提供了三个自动化部署脚本：

| 脚本 | 位置 | 用途 |
|------|------|------|
| `pack.sh` | `scripts/pack.sh` | 本地打包 |
| `deploy.sh` | `scripts/deploy.sh` | 线上部署 |
| `register.sh` | `scripts/register.sh` | 数据库注册 |

### 快速使用

```bash
# 1. 本地打包
cd extensions/buildingai-xhs-creator
./scripts/pack.sh

# 2. 上传到服务器
scp dist/buildingai-xhs-creator-v1.1.0.zip user@server:/tmp/

# 3. 服务器部署
ssh user@server
cd /path/to/buildingai
./extensions/buildingai-xhs-creator/scripts/deploy.sh /tmp/buildingai-xhs-creator-v1.1.0.zip

# 4. 数据库注册（如需要）
./extensions/buildingai-xhs-creator/scripts/register.sh
pm2 restart all
```

详细说明请参考 `scripts/README.md`。

---

## 7. 常见问题

### Q1: 部署后扩展不显示怎么办？

**原因**：可能是数据库中没有注册

**解决方案**：
1. 运行 `./scripts/register.sh` 生成注册 SQL
2. 执行 SQL 或重启服务自动加载

### Q2: 升级后数据丢失怎么办？

**原因**：未正确备份 data/ 和 storage/ 目录

**解决方案**：
- 使用 `deploy.sh` 脚本，会自动备份和恢复
- 手动部署时先备份这些目录

### Q3: 前端页面 404 怎么办？

**原因**：前端资源未复制到 public 目录

**解决方案**：
```bash
cp -r extensions/{identifier}/.output/public/* \
      public/web/extensions/{identifier}/
```

### Q4: PM2 重启后扩展报错怎么办？

**可能原因**：
1. 依赖未安装 → 执行 `pnpm install`
2. 构建产物不完整 → 重新执行 `pnpm build:publish`
3. 数据库 schema 未同步 → 检查日志，手动同步

### Q5: 本地与线上 isLocal 有什么区别？

| isLocal | 说明 |
|---------|------|
| `true` | 本地开发扩展，不会与市场版本对比更新 |
| `false` | 市场安装扩展，会检测是否有新版本 |

建议手动安装的扩展设置 `isLocal: true`。

---

## 8. 注意事项

1. **权限设置**：确保目录有正确的读写权限
   ```bash
   chmod -R 755 extensions/
   chmod -R 755 public/web/extensions/
   ```

2. **PM2 重启**：安装后必须重启 PM2 进程才能加载新扩展

3. **数据库同步**：如果扩展有自定义数据表，首次安装会自动创建

4. **版本管理**：建议使用语义化版本号（如 1.0.0, 1.1.0）

5. **备份策略**：部署前建议备份现有数据

---

> **文档版本**: 1.0.0  
> **最后更新**: 2025-12-07  
> **相关文档**:  
> - [扩展管理API文档](./扩展管理API文档.md)
> - [技术架构文档](./技术架构文档.md)
> - [脚本使用指南](../scripts/README.md)
