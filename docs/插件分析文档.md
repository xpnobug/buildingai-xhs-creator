# buildingai-xhs-creator 插件分析文档

## 📋 插件概述

**插件名称**: 小红书图文生成器 (buildingai-xhs-creator)  
**版本**: 1.1.0 (manifest: 1.0.2)  
**作者**: couei  
**类型**: 应用插件 (type: 1)  
**状态**: 已启用，本地安装

### 核心功能
这是一个AI驱动的小红书图文内容生成插件，能够根据用户输入的主题自动生成多页图文内容，包括：
- 智能大纲生成（6-9页结构化内容）
- 批量图片生成（封面图 + 内容图）
- 风格一致性保持（支持参考图片）
- 实时进度追踪（SSE流式返回）
- 历史记录管理（瀑布流展示）
- **[NEW] 积分计费系统**（大纲/图片积分消费控制、免费次数配置）
- **[NEW] 图片版本管理**（历史版本查看、恢复）
- **[NEW] 后台配置管理**（模型选择、积分设置、免费次数配置）

---

## 🏗️ 架构设计

### 1. 技术栈

**后端 (NestJS)**
- NestJS 框架
- TypeORM 数据库ORM
- RxJS 响应式编程（SSE流式传输）
- BuildingAI SDK 集成

**前端 (Nuxt 3 + Vue 3)**
- Nuxt 3 框架
- Vue 3 Composition API
- Pinia 状态管理
- 瀑布流布局组件 (`vue-waterfall-plugin-next`)

### 2. 目录结构

```
buildingai-xhs-creator/
├── src/
│   ├── api/                    # 后端API
│   │   ├── db/
│   │   │   ├── entities/       # 数据库实体
│   │   │   ├── migrations/     # 数据库迁移
│   │   │   └── seeds/          # 数据种子
│   │   ├── modules/
│   │   │   ├── xhs-creator/    # 核心模块
│   │   │   │   ├── controllers/    # 控制器
│   │   │   │   ├── services/       # 业务服务
│   │   │   │   ├── generators/    # AI生成器
│   │   │   │   └── dto/           # 数据传输对象
│   │   │   ├── article/        # 文章模块（博客功能）
│   │   │   └── category/       # 分类模块（博客功能）
│   │   └── index.ts
│   └── web/                    # 前端应用
│       ├── pages/              # 页面路由
│       ├── components/          # 组件
│       ├── services/            # API服务
│       ├── stores/              # 状态管理
│       └── i18n/               # 国际化
├── build/                      # 编译输出
├── data/                       # 插件数据
└── manifest.json               # 插件清单
```

---

## 🗄️ 数据模型

### 核心实体

#### 1. XhsTask (任务实体)
```typescript
- id: UUID (主键)
- topic: string (用户输入的主题)
- outline: text (AI生成的完整大纲)
- pages: JSONB (页面结构化数据)
- status: TaskStatus (任务状态枚举)
- userImages: string[] (用户上传的参考图片)
- coverImageUrl: string (封面图片URL)
- totalPages: number (总页数)
- generatedPages: number (已生成页数)
- errorMessage: string (错误信息)
- userId: UUID (创建用户ID)
```

**任务状态流转**:
```
PENDING → GENERATING_OUTLINE → OUTLINE_READY → GENERATING_IMAGES → COMPLETED
                                                      ↓
                                                   FAILED
```

#### 2. XhsImage (图片实体)
```typescript
- id: UUID (主键)
- taskId: UUID (所属任务ID)
- pageIndex: number (页面索引)
- pageType: "cover" | "content" | "summary" (页面类型)
- prompt: string (图片生成提示词)
- imageUrl: string (生成的图片URL)
- status: ImageStatus (生成状态)
- errorMessage: string (错误信息)
- retryCount: number (重试次数)
```

#### 3. XhsConfig (配置实体)
```typescript
- id: UUID (主键)
- bindKeyConfigId: string (绑定的密钥配置ID)
- textKeyConfigId: string (文本生成密钥配置ID)
- imageKeyConfigId: string (图片生成密钥配置ID)
- textModel: string (文本生成模型，默认: gpt-4o-mini)
- textModelId: UUID (系统AI模型ID-文本)
- imageModel: string (图片生成模型，默认: gpt-image-1)
- imageModelId: UUID (系统AI模型ID-图片)
- imageEndpointType: "images" | "chat" | "custom" (图片生成端点类型)
- imageEndpointUrl: string (自定义端点URL)
- coverImagePower: number (封面图消耗积分，默认: 80)
- contentImagePower: number (内容图消耗积分，默认: 40)
- outlinePower: number (大纲生成消耗积分，默认: 10) [NEW]
- freeUsageLimit: number (用户免费使用总次数，默认: 5) [NEW]
- highConcurrency: boolean (是否启用高并发图片生成模式) [NEW]
```

#### 4. XhsUserUsage (用户使用统计实体) [NEW v1.1.0]
```typescript
- id: UUID (主键)
- userId: string (用户ID，唯一约束)
- freeUsageCount: number (已使用免费次数，默认: 0)
- createdAt: Date (创建时间)
- updatedAt: Date (更新时间)
```

#### 5. XhsImageHistory (图片版本历史实体) [NEW v1.0.2]
```typescript
- id: UUID (主键)
- imageId: UUID (关联的主图片记录ID)
- taskId: UUID (所属任务ID)
- pageIndex: number (页面索引)
- version: number (版本号，从1开始递增)
- imageUrl: string (该版本的图片URL)
- prompt: string (该版本使用的提示词)
- generatedBy: "initial" | "single-regenerate" | "batch-regenerate" (生成方式)
- powerAmount: number (消耗的积分数量)
- isCurrent: boolean (是否为当前使用的版本)
- createdAt: Date (版本创建时间)
```

#### 6. XhsProvider (供应商实体)
用于管理AI供应商配置

---

## 🔄 业务流程

### 完整生成流程

```
1. 用户输入主题 + 上传参考图（可选）
   ↓
2. 创建任务 (TaskStatus: PENDING)
   ↓
3. 生成大纲 (OutlineService)
   - 调用系统AI模型生成大纲
   - 解析大纲为页面结构（封面、内容、总结）
   - 更新任务状态 (OUTLINE_READY)
   ↓
4. 用户编辑大纲（可选）
   ↓
5. 批量生成图片 (ImageService)
   - 创建图片记录
   - 第一阶段：生成封面图
   - 第二阶段：生成内容页图片（使用封面作为参考）
   - SSE流式返回进度
   - 更新任务状态 (COMPLETED)
   ↓
6. 用户查看结果并导出
```

### 关键服务

#### OutlineService (大纲生成服务)
- **功能**: 根据主题生成小红书图文大纲
- **实现**:
  - 构建提示词（包含主题、参考图片信息）
  - 调用系统统一AI模型服务（与主系统对话一致）
  - 解析大纲文本为结构化页面数据
- **输出格式**:
  ```
  【第1页 - 封面】
  文字: xxx
  图片描述: xxx
  
  【第2页 - 内容】
  文字: xxx
  图片描述: xxx
  ...
  ```

#### ImageService (图片生成服务)
- **功能**: 批量生成图片，支持SSE流式返回进度
- **特点**:
  - 分阶段生成：先封面，后内容页
  - 风格一致性：内容页使用封面作为参考图
  - 实时进度：通过SSE推送生成状态
  - 错误处理：记录失败原因，支持重试
  - **[NEW] 高并发模式**：可选并行生成内容页图片
- **生成器模式**:
  - 根据 `imageEndpointType` 选择不同的生成器
  - 支持三种端点类型：
    - `images`: OpenAI Images API
    - `chat`: Chat Completions API (Gemini, Claude等)
    - `custom`: 自定义端点

#### XhsBillingService (统一计费服务) [NEW v1.1.0]
- **功能**: 管理大纲生成和图片生成的免费次数与积分扣减
- **核心方法**:
  - `hasFreeUsage(userId)`: 检查用户是否有免费次数
  - `getRemainingFreeCount(userId)`: 获取用户剩余免费次数
  - `consume(userId, type, pageType)`: 消费一次（优先使用免费次数，否则扣积分）
  - `rollbackPower(userId, powerAmount)`: 生成失败时回退积分
  - `hasSufficientBalance(userId, requiredPower)`: 检查余额是否足够
- **计费逻辑**:
  1. 优先消费免费次数（大纲和图片共用）
  2. 免费次数用完后扣减积分
  3. 生成失败自动回退积分

#### ImageVersionService (图片版本管理服务) [NEW v1.0.2]
- **功能**: 负责图片版本历史的保存、查询、恢复
- **核心方法**:
  - `saveVersion(options)`: 保存图片版本记录
  - `getVersions(taskId, pageIndex)`: 获取图片的所有历史版本
  - `getVersion(taskId, pageIndex, version)`: 获取特定版本的图片
  - `restoreVersion(taskId, pageIndex, version)`: 恢复到指定版本
  - `incrementVersion(imageId)`: 递增版本号
- **版本策略**:
  - 恢复版本不创建新版本，只切换 `isCurrent` 标记
  - 每次重绘自动递增版本号并保存历史

---

## 🎨 前端界面

### 页面路由

1. **`/xhs`** (index.vue) - 主页面（图文生成）
   - 四个步骤：输入需求 → 编辑大纲 → 生成图片 → 导出结果
   - 步骤式导航，支持前进/后退

2. **`/xhs/outline`** - 大纲编辑页（独立路由）

3. **`/xhs/generate`** - 图片生成页（独立路由）

4. **`/xhs/result`** - 结果展示页（独立路由）

5. **`/history`** (history.vue) - 历史记录页 [重构]
   - 小红书 explore 风格瀑布流布局
   - 触底自动加载更多
   - 任务卡片悬浮预览/编辑
   - TaskDetailModal 弹窗查看详情

6. **`/console`** (console/index.vue) - 后台管理首页 [NEW]

7. **`/console/config`** (console/config.vue) - 后台配置管理页 [NEW]
   - 基础信息配置（插件名称、模型选择）
   - 积分配置（大纲/封面图/内容图积分设置）
   - 免费次数配置
   - 图片生成端点类型选择

### 核心组件

#### 1. ComposerInput
- 主题输入框
- 参考图片上传
- 生成按钮

#### 2. OutlineStep
- 大纲展示与编辑
- 页面排序
- 文案润色

#### 3. GenerateStep
- 实时进度展示（SSE）
- 图片预览
- 进度条

#### 4. ResultStep
- 最终结果展示
- 批量下载
- 重新生成

### 状态管理 (Pinia Store)

```typescript
useXhsCreatorStore {
  - topic: string (主题)
  - userImages: string[] (参考图片)
  - pages: Page[] (页面列表)
  - taskId: string (任务ID)
  - generateOutline(): 生成大纲
  - updatePage(): 更新页面
  - ...
}
```

---

## 🔌 AI生成器架构

### 生成器模式

插件采用策略模式实现多种AI生成器：

#### BaseGenerator (抽象基类)
```typescript
abstract class BaseGenerator {
  abstract generateText(prompt, options): Promise<string>
  abstract generateImage(prompt, options): Promise<string>
}
```

#### 具体实现

1. **OpenAIGenerator**
   - 使用 OpenAI Images API (`/v1/images/generations`)
   - 适用于 DALL-E 等模型

2. **ChatCompletionsGenerator**
   - 使用 Chat Completions API (`/v1/chat/completions`)
   - 适用于 Gemini、Claude 等支持图片生成的模型

3. **CustomEndpointGenerator**
   - 自定义端点URL
   - 适用于非标准API

### 模型配置

- **文本模型**: 通过 `textModelId` 关联系统AI模型
- **图片模型**: 通过 `imageModelId` 关联系统AI模型
- **密钥管理**: 通过 `PublicAiModelService` 获取供应商密钥配置
- **统一调用链**: 与主系统对话使用相同的调用链，避免密钥处理差异

---

## 🔐 权限与安全

### 认证要求
- 所有API接口需要用户认证 (`auth: true`)
- 使用 `ExtensionWebController` 装饰器自动处理路由前缀

### 数据隔离
- 任务关联 `userId`，实现用户数据隔离
- 图片上传到插件专用存储目录

---

## 💰 积分计费

### 计费规则
- **封面图**: 80积分/张（默认）
- **内容图**: 40积分/张（默认）
- 可在后台配置中修改

### 计费时机
- 图片生成成功时扣除积分
- 失败不扣费

---

## 📊 数据种子 (Seeds)

插件包含初始数据种子：

1. **CategorySeeder** - 博客分类种子
2. **ArticleSeeder** - 博客文章种子
3. **InitialSeeder** - 初始化种子

种子数据文件：
- `blog-categories.json`
- `blog-articles.json`

---

## 🔄 升级机制

插件支持版本升级：
- `upgrade/0.0.2/index.ts` - 0.0.2版本升级脚本

---

## 🌐 国际化

支持多语言：
- 中文 (zh)
- 英文 (en)
- 日文 (jp)

翻译文件：
- `article.json` - 文章相关翻译
- `column.json` - 专栏相关翻译

---

## 📝 API接口

### 大纲相关
- `POST /api/extensions/buildingai-xhs-creator/outline` - 生成大纲

### 图片相关
- `POST /api/extensions/buildingai-xhs-creator/images/generate` - 批量生成图片（SSE）
- `POST /api/extensions/buildingai-xhs-creator/images/regenerate` - 重新生成单张图片
- `GET /api/extensions/buildingai-xhs-creator/images/:taskId/:pageIndex/versions` - 获取图片版本历史 [NEW]
- `POST /api/extensions/buildingai-xhs-creator/images/:taskId/:pageIndex/restore/:version` - 恢复到指定版本 [NEW]

### 任务相关
- `GET /api/extensions/buildingai-xhs-creator/tasks` - 获取任务列表
- `GET /api/extensions/buildingai-xhs-creator/tasks/:id` - 获取任务详情

### 配置相关
- `GET /api/extensions/buildingai-xhs-creator/config` - 获取配置
- `PUT /api/extensions/buildingai-xhs-creator/config` - 更新配置

### 余额相关 [NEW v1.1.0]
- `POST /api/extensions/buildingai-xhs-creator/balance/check` - 检查用户余额是否充足

### 供应商相关
- `GET /api/extensions/buildingai-xhs-creator/providers` - 获取供应商列表
- `POST /api/extensions/buildingai-xhs-creator/providers` - 创建供应商

---

## 🎯 核心特性

### 1. 智能大纲生成
- AI自动生成6-9页结构化内容
- 包含封面、内容页、总结页
- 每页包含文字内容和图片描述

### 2. 风格一致性
- 支持上传参考图片
- 封面图作为后续内容页的参考
- 保持整体视觉风格统一

### 3. 实时进度追踪
- SSE流式返回生成进度
- 实时显示当前生成状态
- 支持错误提示和重试

### 4. 灵活的模型配置
- 文本和图片模型独立配置
- 支持多种AI供应商
- 支持自定义端点

### 5. 完整的任务管理
- 任务状态追踪
- 历史记录查看
- 错误信息记录

---

## 🚀 部署与构建

### 构建命令
```bash
# 开发模式
pnpm dev:api      # 后端开发
pnpm dev:web      # 前端开发
pnpm dev          # 同时启动前后端

# 生产构建
pnpm build:api    # 构建后端
pnpm build:web    # 构建前端
pnpm build:publish # 完整构建并发布
```

### 构建输出
- `build/api/` - 编译后的后端代码
- `.output/` - Nuxt构建输出
- `dist/` - 发布包

---

## 📦 依赖关系

### 核心依赖
- `@buildingai/extension-sdk` - 插件SDK
- `@buildingai/ai-sdk` - AI SDK
- `@buildingai/db` - 数据库工具
- `@buildingai/core` - 核心功能
- `rxjs` - 响应式编程（SSE）

### UI依赖
- `vue-waterfall-plugin-next` - 瀑布流布局

---

## 🔍 代码质量

### 代码规范
- ESLint配置 (`eslint.config.mjs`)
- TypeScript严格模式
- Prettier代码格式化

### 类型安全
- 完整的TypeScript类型定义
- DTO验证
- 实体类型定义

---

## 🐛 已知问题与改进建议

### 潜在问题
1. **错误处理**: 部分错误可能未完全捕获
2. **重试机制**: 图片生成失败后的重试逻辑可以优化
3. **并发控制**: 大量并发请求时的性能优化

### 改进建议
1. 添加图片生成队列机制
2. 优化SSE连接管理
3. 添加更多图片生成参数配置
4. 支持批量任务管理
5. 添加图片编辑功能

---

## 📚 相关文档

- `SEEDS.md` - 种子机制使用说明
- `README.md` - 插件说明
- `manifest.json` - 插件清单

---

## 📝 版本更新日志

### v1.0.2 (2025-12-04)
- ✨ 新增图片版本管理功能
- 📊 新增图片版本历史记录表 (`XhsImageHistory`)
- 🔄 支持查看和恢复每次重绘的历史版本
- 💾 自动迁移现有图片数据作为初始版本

### v1.0.1 (2025-12-04)
- ✨ 新增图片生成积分计费功能
- 🔧 新增积分预扣减和失败回退机制
- 💾 新增积分计费相关数据库字段
- 🔄 新增自动数据库字段检测和更新机制
- 📝 完善积分扣减日志和追溯功能

### v1.0.0 (2024-xx-xx)
- 🎉 初始版本发布
- ✨ 实现小红书图文生成核心功能

---

## 🎓 总结

`buildingai-xhs-creator` 是一个功能完整、架构清晰的小红书图文生成插件。它充分利用了BuildingAI平台的扩展能力，实现了从大纲生成到图片生成的完整流程。插件采用模块化设计，支持多种AI模型和端点类型，具有良好的扩展性和可维护性。

**核心优势**:
- ✅ 完整的业务流程
- ✅ 灵活的AI模型配置
- ✅ 实时进度追踪
- ✅ 风格一致性保证
- ✅ 良好的用户体验
- ✅ 积分/免费次数计费系统 [NEW]
- ✅ 图片版本历史管理 [NEW]
- ✅ 后台配置管理 [NEW]

**适用场景**:
- 品牌营销内容创作
- 小红书种草分享
- 多图文内容生成
- 批量内容生产

